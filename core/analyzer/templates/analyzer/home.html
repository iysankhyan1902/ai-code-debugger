<!DOCTYPE html>
<html lang="en">
<head>
    <title>AI Code Debugging Assistant</title>
    {% load static %}
    <link rel="stylesheet" href="/static/css/style.css">
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle theme">
    üåô
</button>
</head>

<body>

<!-- HERO SECTION -->
<header class="hero">
    <h1>AI Code Debugging Assistant</h1>
    <p>Analyze Python errors and get clear, reliable fixes powered by AI.</p>
</header>

<!-- MAIN CONTENT -->
<main class="container">

    <!-- DEBUG FORM CARD -->
    <section class="card main-card">
        <form id="debugForm">

            <!-- CODE EDITOR -->
            <label class="section-title">Python Code</label>

            <div id="editor" class="code-box" style="height: 300px;"></div>

            <!-- EDITOR ACTIONS -->
            <div class="editor-actions">
                <button type="button" id="clearCodeBtn">Clear Code</button>

                <div class="editor-stats">
                    <span id="lineCount">Lines: 0</span>
                    <span id="charCount">Chars: 0</span>
                </div>
            </div>

            <!-- ERROR INPUT -->
            <label class="section-title">Error Message</label>
            <textarea
                id="error"
                class="error-box"
                placeholder="Paste the error message (optional)"
            ></textarea>

            <!-- MODE SELECTION -->
            <div class="radio-group">
                <label>
                    <input type="radio" name="mode" value="hint">
                    Hint only
                </label>
                <label>
                    <input type="radio" name="mode" value="full" checked>
                    Full solution
                </label>
            </div>

            <!-- SUBMIT -->
            <button type="submit">Debug Code</button>
        </form>
    </section>

    <!-- OUTPUT CARD -->
    <section class="card output-card">
        <div class="output-header">
            <h3>AI Analysis</h3>
            <button type="button" id="copyOutputBtn">Copy</button>
        </div>
        <div class="output-section">
    <h4>‚ùå ERROR_REASON</h4>
    <p id="errorReason">Waiting for input...</p>
</div>

<div class="output-section">
    <h4>üìç PROBLEM_LINE</h4>
    <p id="problemLine">‚Äî</p>
</div>

<div class="output-section">
    <h4>üß† EXPLANATION</h4>
    <p id="explanation">‚Äî</p>
</div>

<div class="output-section">
    <h4>üõ†Ô∏è FIXED_CODE</h4>
    <pre><code id="fixedCode">‚Äî</code></pre>
</div>

<div class="output-section">
    <h4>‚úÖ EXAMPLE</h4>
    <pre><code id="example">‚Äî</code></pre>
</div>

        

        <button type="button" id="clearOutputBtn">Clear Output</button>
    </section>

</main>

<!-- MONACO EDITOR -->
<script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>

<script>
    let editor;

    require.config({
        paths: {
            vs: "https://unpkg.com/monaco-editor@0.45.0/min/vs"
        }
    });

    require(["vs/editor/editor.main"], function () {
        editor = monaco.editor.create(
            document.getElementById("editor"),
            {
                value: "# Write your Python code here\n",
                language: "python",
                theme: "vs-dark",
                automaticLayout: true,
                fontSize: 14
            }
        );

        editor.onDidChangeModelContent(updateStats);
        updateStats();
    });

    function updateStats() {
        const code = editor.getValue();
        document.getElementById("lineCount").innerText =
            `Lines: ${code.split("\n").length}`;
        document.getElementById("charCount").innerText =
            `Chars: ${code.length}`;
    }
</script>

<!-- UI ACTIONS -->
<script>
    // Clear code
    document.getElementById("clearCodeBtn").addEventListener("click", () => {
        editor.setValue("");
    });

    // Clear output
    document.getElementById("clearOutputBtn").addEventListener("click", () => {
        document.getElementById("output").innerText = "Waiting for input...";
    });

    // Copy output
    document.getElementById("copyOutputBtn").addEventListener("click", function () {
        const text = `
ERROR_REASON:
${errorReason.innerText}

PROBLEM_LINE:
${problemLine.innerText}

EXPLANATION:
${explanation.innerText}

FIXED_CODE:
${fixedCode.innerText}

EXAMPLE:
${example.innerText}
`;


        if (!text || text === "Waiting for input...") {
            alert("Nothing to copy!");
            return;
        }

        const textarea = document.createElement("textarea");
        textarea.value = text;

        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);

        this.innerText = "Copied!";
        setTimeout(() => (this.innerText = "Copy"), 1500);
    });

    // Theme toggle
    const btn = document.getElementById("themeToggle");

  // check saved theme
  if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
    btn.innerText = "‚òÄÔ∏è";
  }

  btn.addEventListener("click", () => {
    document.body.classList.toggle("light");

    if (document.body.classList.contains("light")) {
      localStorage.setItem("theme", "light");
      btn.innerText = "‚òÄÔ∏è Light Mode";
    } else {
      localStorage.setItem("theme", "dark");
      btn.innerText = "üåô Dark Mode";

    }
  });
</script>
<script>
function renderAIOutput(rawText) {
    const sections = {
        ERROR_REASON: "",
        PROBLEM_LINE: "",
        EXPLANATION: "",
        FIXED_CODE: "",
        EXAMPLE: ""
    };

    let currentKey = null;

    rawText.split("\n").forEach(line => {
        const trimmed = line.trim();

        if (trimmed.startsWith("ERROR_REASON:")) {
            currentKey = "ERROR_REASON";
            sections[currentKey] = trimmed.replace("ERROR_REASON:", "").trim();
        } 
        else if (trimmed.startsWith("PROBLEM_LINE:")) {
            currentKey = "PROBLEM_LINE";
            sections[currentKey] = trimmed.replace("PROBLEM_LINE:", "").trim();
        } 
        else if (trimmed.startsWith("EXPLANATION:")) {
            currentKey = "EXPLANATION";
            sections[currentKey] = trimmed.replace("EXPLANATION:", "").trim();
        } 
        else if (trimmed.startsWith("FIXED_CODE:")) {
            currentKey = "FIXED_CODE";
            sections[currentKey] = "";
        } 
        else if (trimmed.startsWith("EXAMPLE:")) {
            currentKey = "EXAMPLE";
            sections[currentKey] = "";
        } 
        else if (currentKey) {
            sections[currentKey] += "\n" + trimmed;
        }
    });

    document.getElementById("errorReason").innerText = sections.ERROR_REASON || "‚Äî";
    document.getElementById("problemLine").innerText = sections.PROBLEM_LINE || "‚Äî";
    document.getElementById("explanation").innerText = sections.EXPLANATION || "‚Äî";
    document.getElementById("fixedCode").innerText = sections.FIXED_CODE || "‚Äî";
    document.getElementById("example").innerText = sections.EXAMPLE || "‚Äî";
}
</script>

<!-- FORM SUBMISSION -->
<script>
    document
        .getElementById("debugForm")
        .addEventListener("submit", async function (e) {
            e.preventDefault();

            const code = editor.getValue();
            const error = document.getElementById("error").value;
            const mode = document.querySelector(
                'input[name="mode"]:checked'
            ).value;
           ["errorReason","problemLine","explanation","fixedCode","example"].forEach(id => {
    document.getElementById(id).innerText = "‚Äî";
});


            if (!code.trim()) {
                output.innerText = "Please enter code before submitting.";
                return;
            }

            

            const response = await fetch("/debug/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ code, error, mode })
            });

            const data = await response.json();
            renderAIOutput(data.error || data.result);

        });
</script>

</body>
</html>